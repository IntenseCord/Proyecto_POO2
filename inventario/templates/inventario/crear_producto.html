{% extends 'inventario/base_inventario.html' %} {% block breadcrumb %}
<li class="breadcrumb-item">
  <a href="{% url 'inventario:lista_productos' %}">Productos</a>
</li>
<li class="breadcrumb-item active">Nuevo Producto</li>
{% endblock %} {% block page_title %}Crear Nuevo Producto{% endblock %} {% block
page_actions %}
<a
  href="{% url 'inventario:lista_productos' %}"
  class="btn btn-outline-secondary"
>
  <i class="fas fa-arrow-left"></i> Volver a Lista
</a>
{% endblock %} {% block inventario_content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card shadow">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
          <i class="fas fa-plus-circle"></i> Información del Producto
        </h6>
      </div>
      <div class="card-body">
        <form method="post" novalidate>
          {% csrf_token %}

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.codigo.id_for_label }}" class="form-label">
                {{ form.codigo.label }}
              </label>
              {{ form.codigo }} {% if form.codigo.help_text %}
              <small class="form-text text-muted"
                >{{ form.codigo.help_text }}</small
              >
              {% endif %} {% if form.codigo.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.codigo.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="col-md-6 mb-3">
              <label for="{{ form.categoria.id_for_label }}" class="form-label">
                {{ form.categoria.label }}
              </label>
              <div class="input-group">
                {{ form.categoria }}
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  data-bs-toggle="modal"
                  data-bs-target="#nuevaCategoriaModal"
                >
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              {% if form.categoria.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.categoria.errors %} {{ error }} {% endfor
                %}
              </div>
              {% endif %}
            </div>
          </div>

          <div class="mb-3">
            <label for="{{ form.nombre.id_for_label }}" class="form-label">
              {{ form.nombre.label }} <span class="text-danger">*</span>
            </label>
            {{ form.nombre }} {% if form.nombre.errors %}
            <div class="invalid-feedback d-block">
              {% for error in form.nombre.errors %} {{ error }} {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="{{ form.descripcion.id_for_label }}" class="form-label">
              {{ form.descripcion.label }}
            </label>
            {{ form.descripcion }} {% if form.descripcion.errors %}
            <div class="invalid-feedback d-block">
              {% for error in form.descripcion.errors %} {{ error }} {% endfor
              %}
            </div>
            {% endif %}
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="{{ form.cantidad.id_for_label }}" class="form-label">
                {{ form.cantidad.label }} <span class="text-danger">*</span>
              </label>
              {{ form.cantidad }} {% if form.cantidad.help_text %}
              <small class="form-text text-muted"
                >{{ form.cantidad.help_text }}</small
              >
              {% endif %} {% if form.cantidad.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.cantidad.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="col-md-4 mb-3">
              <label
                for="{{ form.precio_unitario.id_for_label }}"
                class="form-label"
              >
                {{ form.precio_unitario.label }}
                <span class="text-danger">*</span>
              </label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                {{ form.precio_unitario }}
              </div>
              {% if form.precio_unitario.help_text %}
              <small class="form-text text-muted"
                >{{ form.precio_unitario.help_text }}</small
              >
              {% endif %} {% if form.precio_unitario.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.precio_unitario.errors %} {{ error }} {%
                endfor %}
              </div>
              {% endif %}
            </div>

            <div class="col-md-4 mb-3">
              <label
                for="{{ form.stock_minimo.id_for_label }}"
                class="form-label"
              >
                {{ form.stock_minimo.label }}
              </label>
              {{ form.stock_minimo }} {% if form.stock_minimo.help_text %}
              <small class="form-text text-muted"
                >{{ form.stock_minimo.help_text }}</small
              >
              {% endif %} {% if form.stock_minimo.errors %}
              <div class="invalid-feedback d-block">
                {% for error in form.stock_minimo.errors %} {{ error }} {%
                endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          <div class="mb-3">
            <label for="{{ form.estado.id_for_label }}" class="form-label">
              {{ form.estado.label }}
            </label>
            {{ form.estado }} {% if form.estado.errors %}
            <div class="invalid-feedback d-block">
              {% for error in form.estado.errors %} {{ error }} {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a
              href="{% url 'inventario:lista_productos' %}"
              class="btn btn-outline-secondary me-md-2"
            >
              <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Guardar Producto
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Nueva Categoría -->
<div
  class="modal fade"
  id="nuevaCategoriaModal"
  tabindex="-1"
  aria-labelledby="nuevaCategoriaModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="nuevaCategoriaModalLabel">
          Nueva Categoría
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="formNuevaCategoria">
          {% csrf_token %}
          <div class="mb-3">
            <label for="nombreCategoria" class="form-label">Nombre</label>
            <input
              type="text"
              class="form-control"
              id="nombreCategoria"
              name="nombre"
              required
            />
          </div>
          <div class="mb-3">
            <label for="descripcionCategoria" class="form-label"
              >Descripción</label
            >
            <textarea
              class="form-control"
              id="descripcionCategoria"
              name="descripcion"
              rows="3"
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="crearCategoria()"
        >
          Crear Categoría
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %} {{ block.super }}
<script>
  function crearCategoria() {
    const form = document.getElementById("formNuevaCategoria");
    const formData = new FormData(form);

    fetch('{% url "inventario:crear_categoria" %}', {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
          .value,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Agregar nueva opción al select
          const select = document.getElementById(
            "{{ form.categoria.id_for_label }}"
          );
          const option = new Option(
            data.categoria.nombre,
            data.categoria.id,
            true,
            true
          );
          select.add(option);

          // Cerrar modal y limpiar formulario
          const modal = bootstrap.Modal.getInstance(
            document.getElementById("nuevaCategoriaModal")
          );
          modal.hide();
          form.reset();

          // Mostrar mensaje de éxito
          alert("Categoría creada exitosamente");
        } else {
          alert("Error al crear la categoría: " + data.error);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("Error al crear la categoría");
      });
  }

  // Calcular valor total automáticamente
  document.addEventListener("DOMContentLoaded", function () {
    const cantidadInput = document.getElementById(
      "{{ form.cantidad.id_for_label }}"
    );
    const precioInput = document.getElementById(
      "{{ form.precio_unitario.id_for_label }}"
    );

    function calcularValorTotal() {
      const cantidad = Number.parseFloat(cantidadInput.value) || 0;
      const precio = Number.parseFloat(precioInput.value) || 0;
      const total = cantidad * precio;

      // Mostrar el valor total calculado (opcional)
      console.log("Valor total:", total.toFixed(2));
    }

    cantidadInput.addEventListener("input", calcularValorTotal);
    precioInput.addEventListener("input", calcularValorTotal);
  });
</script>
{% endblock %}
